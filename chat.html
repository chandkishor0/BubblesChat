<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bubble Chat</title>
<link rel="stylesheet" href="style.css">
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
</head>
<body>
<div class="container chat-container">
  <h2>Bubble Chat</h2>
  <div class="user-list" id="user-list"></div>
  <div id="chat-box" class="chat-box"></div>
  <div class="input-area">
    <input type="text" id="message" placeholder="Type a message">
    <button id="sendBtn">Send</button>
  </div>
  <div class="bubbles"></div>
</div>

<script>
const currentUser = localStorage.getItem('user');
const chatWithUser = localStorage.getItem('chatWith');
let selectedUser = chatWithUser;

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyB5C4PYCKfY9Rk7CVPNQ-JHX7iBF-DP4cE",
  authDomain: "bubblechat-8b913.firebaseapp.com",
  databaseURL: "https://bubblechat-8b913-default-rtdb.firebaseio.com",
  projectId: "bubblechat-8b913",
  storageBucket: "bubblechat-8b913.appspot.com",
  messagingSenderId: "890679022385",
  appId: "1:890679022385:web:0391f6e09e0efdaa661610"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Show only one user button
document.getElementById('user-list').innerHTML = `<button onclick="selectUser('${chatWithUser}')">${chatWithUser}</button>`;

// Chat ID
function getChatId(u1,u2){ return [u1,u2].sort().join('_'); }

// Select user & load chat
function selectUser(user){
  selectedUser = user;
  const chatBox = document.getElementById('chat-box');
  chatBox.innerHTML = '';
  const chatRef = db.ref('chats/' + getChatId(currentUser, selectedUser));
  chatRef.off();
  chatRef.on('child_added', snapshot => {
    const data = snapshot.val();
    appendMessage(data.from, data.message);
  });
}

// Append message
function appendMessage(user,msg){
  const chatBox = document.getElementById('chat-box');
  const div = document.createElement('div');
  div.className = user===currentUser ? 'message self' : 'message other';
  div.textContent = msg;
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}

// Send message
document.getElementById('sendBtn').addEventListener('click', function(){
  const msg = document.getElementById('message').value.trim();
  if(!msg || !selectedUser) return;
  const chatRef = db.ref('chats/' + getChatId(currentUser, selectedUser));
  chatRef.push({ from: currentUser, message: msg });
  document.getElementById('message').value = '';
});

// Auto-load
selectUser(chatWithUser);
</script>
</body>
</html>
