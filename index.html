<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bubble Chat</title>
<style>
/* Body & background */
body { margin:0; font-family:Arial,sans-serif; overflow:hidden; height:100vh; display:flex; justify-content:center; align-items:center; background:linear-gradient(135deg,#ff9a9e,#fad0c4); }

/* Floating bubbles */
.bubble { position:absolute; bottom:-100px; background:rgba(255,255,255,0.2); border-radius:50%; animation:rise 20s infinite ease-in; }
@keyframes rise { from{transform:translateY(0) scale(1);} to{transform:translateY(-110vh) scale(1.5);} }

/* Login overlay */
.login-overlay { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(255,255,255,0.95); display:flex; justify-content:center; align-items:center; z-index:10; }
.login-box { padding:25px; border-radius:15px; background:#fff; box-shadow:0 6px 15px rgba(0,0,0,0.3); display:flex; flex-direction:column; align-items:center; }
.login-box input { width:220px; padding:12px; margin:7px 0; border-radius:10px; border:1px solid #ccc; font-size:14px; }
.login-box button { width:100%; padding:12px; background:#FF4081; border:none; color:#fff; border-radius:10px; cursor:pointer; font-size:16px; transition:0.3s; }
.login-box button:hover { background:#e91e63; }

/* Chat container */
.chat-container { display:none; position:relative; width:100%; max-width:420px; height:90vh; backdrop-filter:blur(10px); background:rgba(0,0,0,0.2); border-radius:20px; display:flex; flex-direction:column; color:white; box-shadow:0px 0px 25px rgba(0,0,0,0.6); padding-top:10px; }
#messages { flex:1; overflow-y:auto; padding:10px; }

/* Chat bubbles */
.msg { padding:10px 14px; margin:6px 0; max-width:75%; word-wrap:break-word; position:relative; display:flex; align-items:flex-end; box-shadow:0 2px 6px rgba(0,0,0,0.2); border-radius:20px; transition:0.2s; }
.sent { background: linear-gradient(135deg,#ff9a9e,#fad0c4); align-self:flex-end; color:black; border-top-right-radius:5px; border-bottom-right-radius:20px; }
.received { background: linear-gradient(135deg,#a18cd1,#fbc2eb); align-self:flex-start; color:black; border-top-left-radius:5px; border-bottom-left-radius:20px; }
.msg:hover { transform:scale(1.02); }
.msg small { font-size:10px; color:#555; position:absolute; bottom:3px; right:8px; }
.delete-btn { background:transparent; border:none; cursor:pointer; margin-left:8px; font-size:12px; color:#f44336; }

/* Input row */
.input-row { display:flex; gap:5px; align-items:center; padding:8px; background:rgba(255,255,255,0.2); border-radius:12px; position:sticky; bottom:0; }
#messageInput { flex:1; padding:10px; border-radius:10px; border:none; }
.send-btn { background:tomato; color:white; border-radius:10px; padding:10px 12px; cursor:pointer; }
.upload-btn { background:#4CAF50; color:white; border-radius:10px; padding:10px 12px; cursor:pointer; }
.clear-btn { background:#e91e63; color:white; border-radius:10px; padding:6px 10px; margin:5px; }

/* Typing */
.typing { font-size:12px; color:#ddd; margin-left:10px; height:15px; }

/* Call buttons */
.call-buttons { position:absolute; top:10px; right:15px; display:flex; gap:8px; }
.call-btn { background:#FF4081; border-radius:50%; padding:10px; cursor:pointer; color:white; font-size:18px; transition:0.3s; }
.call-btn:hover { opacity:0.8; }
.video-btn { background:#9C27B0; }

/* Incoming call overlay */
.incoming-call { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); display:none; justify-content:center; align-items:center; flex-direction:column; color:white; z-index:20; }
.incoming-call button { margin:10px; padding:12px 20px; border-radius:8px; cursor:pointer; font-size:16px; transition:0.2s; }
.accept { background:green; color:white; }
.reject { background:red; color:white; }
.incoming-call button:hover { opacity:0.9; }

/* Video Call Overlay */
#videoCallContainer { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:30; flex-direction:column; justify-content:center; align-items:center; }
video { width:45%; border-radius:12px; margin:5px; background:black; }
#endCallBtn { position:absolute; bottom:20px; padding:10px 20px; background:red; color:white; border:none; border-radius:8px; cursor:pointer; font-size:16px; }

/* Avatars */
.avatar { width:35px; height:35px; border-radius:50%; margin-right:5px; display:inline-block; text-align:center; font-size:20px; }
</style>
</head>
<body>

<!-- Bubble background -->
<div class="bubble" style="width:40px; height:40px; left:10%; animation-duration:18s;"></div>
<div class="bubble" style="width:25px; height:25px; left:30%; animation-duration:25s;"></div>
<div class="bubble" style="width:60px; height:60px; left:70%; animation-duration:22s;"></div>
<div class="bubble" style="width:15px; height:15px; left:50%; animation-duration:30s;"></div>

<!-- Login -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-box">
    <h2>Login to Bubble Chat</h2>
    <input type="text" id="username" placeholder="Hint: Anuradha / Chand Kishor">
    <input type="password" id="password" placeholder="Enter password">
    <button onclick="login()">Enter Chat</button>
  </div>
</div>

<!-- Chat -->
<div class="chat-container" id="chatContainer">
  <h2 id="welcome"></h2>

  <div class="call-buttons">
    <div class="call-btn" onclick="initiateCall('audio')">ðŸ“ž</div>
    <div class="call-btn video-btn" onclick="initiateCall('video')">ðŸ“¹</div>
  </div>

  <div id="messages"></div>
  <div id="typing" class="typing"></div>

  <div class="input-row">
    <input type="text" id="messageInput" placeholder="Type your message..." oninput="showTyping()" />
    <button class="send-btn" onclick="sendMessage()">Send</button>
    <button class="upload-btn" onclick="document.getElementById('imageInput').click()">ðŸ“·</button>
    <input type="file" id="imageInput" accept="image/*" style="display:none" onchange="sendImage(event)">
  </div>

  <button class="clear-btn" onclick="clearChat()">ðŸ—‘ Clear Chat</button>
</div>

<!-- Incoming call -->
<div class="incoming-call" id="incomingCall">
  <h2>Incoming Call...</h2>
  <button class="accept">Accept</button>
  <button class="reject">Reject</button>
</div>

<!-- Video Call Overlay -->
<div id="videoCallContainer">
  <video id="localVideo" autoplay muted></video>
  <video id="remoteVideo" autoplay></video>
  <button id="endCallBtn">End Call</button>
</div>

<audio id="ringtone" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" loop></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, onValue, set, update, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

// --- Firebase ---
const firebaseConfig = {
  apiKey: "AIzaSyB5C4PYCKfY9Rk7CVPNQ-JHX7iBF-DP4cE",
  authDomain: "bubblechat-8b913.firebaseapp.com",
  databaseURL: "https://bubblechat-8b913-default-rtdb.firebaseio.com/",
  projectId: "bubblechat-8b913",
  storageBucket: "bubblechat-8b913.appspot.com",
  messagingSenderId: "890679022385",
  appId: "1:890679022385:web:0391f6e09e0efdaa661610"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let currentUser = null;

// ------------- Login ----------------
function login(){
  const unameVal = document.getElementById("username").value.trim().toLowerCase();
  const passVal = document.getElementById("password").value.trim();

  if(unameVal==="anuradha" && passVal==="Anuradha8877") currentUser="Anuradha8877";
  else if(unameVal==="chand kishor" && passVal==="Chand6202") currentUser="Chand6202";
  else { alert("Invalid login!"); return; }

  document.getElementById("loginOverlay").style.display="none";
  document.getElementById("chatContainer").style.display="flex";
  document.getElementById("welcome").innerText = "Welcome " + (unameVal==="anuradha"?"Anuradha":"Chand Kishor");
  loadMessages();
  listenCalls();
}
window.login = login;

// ------------- Chat ----------------
// ------------------ Load Messages ------------------
function loadMessages(){
  const msgRef = ref(db,"messages");
  onChildAdded(msgRef, snap => displayMessage(snap.key, snap.val()));
}

function displayMessage(id,msg){
  const div = document.createElement("div");
  div.classList.add("msg", msg.user===currentUser?"sent":"received");

  // Avatar
  const avatar = document.createElement("span");
  avatar.className = "avatar";
  avatar.innerText = msg.user==="Anuradha8877"?"ðŸ‘©":"ðŸ‘¨";
  div.appendChild(avatar);

  // Text or Image
  const content = document.createElement("span");
  if(msg.text) content.innerText = msg.text;
  if(msg.image) {
    const img = document.createElement("img");
    img.src = msg.image;
    content.appendChild(img);
  }
  div.appendChild(content);

  // Read receipt
  const tick = document.createElement("small");
  tick.innerText = msg.status==="sent"?"âœ…":msg.status==="delivered"?"âœ…âœ…":"ðŸ”µ";
  div.appendChild(tick);

  // Delete button
  const delBtn = document.createElement("button");
  delBtn.className = "delete-btn";
  delBtn.innerText = "ðŸ—‘";
  delBtn.onclick = () => {
    if(currentUser==="Chand6202" || currentUser===msg.user){
      remove(ref(db,"messages/"+id));
      div.remove();
    } else alert("Only admin can delete others messages!");
  };
  div.appendChild(delBtn);

  document.getElementById("messages").appendChild(div);
  document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;

  // Update status
  if(msg.user!==currentUser){
    update(ref(db,"messages/"+id),{status:"delivered"});
    setTimeout(()=> update(ref(db,"messages/"+id),{status:"read"}),2000);
  }
}

// ------------------ Send Message ------------------
function sendMessage(){
  const txt = document.getElementById("messageInput").value.trim();
  if(!txt) return;
  push(ref(db,"messages"),{text:txt,user:currentUser,status:"sent"});
  document.getElementById("messageInput").value="";
}
window.sendMessage = sendMessage;

// ------------------ Send Image ------------------
function sendImage(event){
  const file = event.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e){
    push(ref(db,"messages"),{image:e.target.result,user:currentUser,status:"sent"});
  }
  reader.readAsDataURL(file);
}
window.sendImage = sendImage;

// ------------------ Clear Chat ------------------
function clearChat(){
  if(currentUser==="Chand6202"){
    set(ref(db,"messages"),{});
    document.getElementById("messages").innerHTML="";
  } else alert("Only admin can clear chat!");
}
window.clearChat = clearChat;

// ------------------ Typing Indicator ------------------
function showTyping(){
  set(ref(db,"typing"),currentUser+" is typing...");
  setTimeout(()=> set(ref(db,"typing"),""),1500);
}
window.showTyping = showTyping;

onValue(ref(db,"typing"), snap => {
  document.getElementById("typing").innerText = snap.val() || "";
});
// ------------------ WebRTC Setup ------------------
let localStream, remoteStream;
let pc;
const servers = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

const videoCallContainer = document.getElementById("videoCallContainer");
const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");
const endCallBtn = document.getElementById("endCallBtn");
const ringtone = document.getElementById("ringtone");

// ------------------ Initiate Call ------------------
function initiateCall(type){
  const toUser = currentUser==="Chand6202"?"Anuradha8877":"Chand6202";
  push(ref(db,"calls"),{
    from: currentUser,
    to: toUser,
    type: type,
    status: "ringing",
    timestamp: Date.now()
  });
}
window.initiateCall = initiateCall;

// ------------------ Listen for Incoming Calls ------------------
function listenCalls(){
  onChildAdded(ref(db,"calls"), async snap => {
    const call = snap.val();
    if(call.to === currentUser && call.status === "ringing"){
      // Show incoming call UI
      const incoming = document.getElementById("incomingCall");
      incoming.style.display = "flex";
      ringtone.play();

      incoming.querySelector(".accept").onclick = async ()=>{
        update(ref(db,"calls/"+snap.key),{status:"accepted"});
        incoming.style.display = "none";
        ringtone.pause();
        await startLocalStream();
        setupPeerConnection(snap.key, call.from);
        alert(`${call.from} ${call.type} call started`);
      };

      incoming.querySelector(".reject").onclick = ()=>{
        update(ref(db,"calls/"+snap.key),{status:"rejected"});
        incoming.style.display = "none";
        ringtone.pause();
      };
    }
  });
}

// ------------------ Local Stream ------------------
async function startLocalStream(){
  localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
  localVideo.srcObject = localStream;
  videoCallContainer.style.display = "flex";
}

// ------------------ Setup PeerConnection ------------------
function setupPeerConnection(callId, remoteUser){
  pc = new RTCPeerConnection(servers);

  // Add local tracks
  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

  // Remote tracks
  pc.ontrack = e => { remoteVideo.srcObject = e.streams[0]; }

  // ICE candidates
  pc.onicecandidate = event => {
    if(event.candidate){
      push(ref(db,"calls/"+callId+"/ice"),{candidate:event.candidate});
    }
  };

  // Listen for remote ICE
  onChildAdded(ref(db,"calls/"+callId+"/ice"), snap=>{
    const data = snap.val();
    pc.addIceCandidate(new RTCIceCandidate(data.candidate));
  });

  // Create offer
  pc.createOffer().then(offer => {
    pc.setLocalDescription(offer);
    update(ref(db,"calls/"+callId),{offer: JSON.stringify(offer)});
  });

  // Listen for answer
  onValue(ref(db,"calls/"+callId+"/answer"), snap=>{
    const answer = snap.val();
    if(answer){
      pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(answer)));
    }
  });
}

// ------------------ End Call ------------------
endCallBtn.onclick = ()=>{
  pc?.close();
  localVideo.srcObject = null;
  remoteVideo.srcObject = null;
  videoCallContainer.style.display = "none";
};
// ------------------ Listen Calls + Handle Offer ------------------
function listenCalls(){
  onChildAdded(ref(db,"calls"), async snap => {
    const call = snap.val();

    // Incoming call
    if(call.to === currentUser && call.status === "ringing"){
      const incoming = document.getElementById("incomingCall");
      incoming.style.display = "flex";
      ringtone.play();

      // Accept call
      incoming.querySelector(".accept").onclick = async ()=>{
        incoming.style.display = "none";
        ringtone.pause();
        await startLocalStream();
        pc = new RTCPeerConnection(servers);

        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
        pc.ontrack = e => { remoteVideo.srcObject = e.streams[0]; }

        // ICE
        pc.onicecandidate = event => {
          if(event.candidate){
            push(ref(db,"calls/"+snap.key+"/ice"), {candidate:event.candidate});
          }
        };

        // Listen remote ICE
        onChildAdded(ref(db,"calls/"+snap.key+"/ice"), snapIce=>{
          const data = snapIce.val();
          pc.addIceCandidate(new RTCIceCandidate(data.candidate));
        });

        // Set remote offer & create answer
        await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(call.offer)));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        update(ref(db,"calls/"+snap.key), {answer: JSON.stringify(answer), status:"accepted"});
        videoCallContainer.style.display = "flex";
      };

      // Reject call
      incoming.querySelector(".reject").onclick = ()=>{
        update(ref(db,"calls/"+snap.key),{status:"rejected"});
        incoming.style.display = "none";
        ringtone.pause();
      };
    }

    // Outgoing call accepted
    if(call.from === currentUser && call.status === "accepted"){
      if(call.answer){
        await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(call.answer)));
        videoCallContainer.style.display = "flex";
      }
    }
  });
}

// ------------------ Start Outgoing Call ------------------
async function initiateCall(type){
  const toUser = currentUser==="Chand6202"?"Anuradha8877":"Chand6202";
  await startLocalStream();

  pc = new RTCPeerConnection(servers);
  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
  pc.ontrack = e => { remoteVideo.srcObject = e.streams[0]; }

  // ICE
  pc.onicecandidate = event => {
    if(event.candidate){
      push(ref(db,"calls/"+callId+"/ice"), {candidate:event.candidate});
    }
  };

  const callRef = push(ref(db,"calls"),{
    from: currentUser,
    to: toUser,
    type: type,
    status: "ringing",
    timestamp: Date.now()
  });

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  update(callRef, {offer: JSON.stringify(offer)});

  // Listen remote ICE and answer
  onChildAdded(ref(db,"calls/"+callRef.key+"/ice"), snapIce=>{
    const data = snapIce.val();
    pc.addIceCandidate(new RTCIceCandidate(data.candidate));
  });

  onValue(ref(db,"calls/"+callRef.key+"/answer"), snap=>{
    const answer = snap.val();
    if(answer){
      pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(answer)));
      videoCallContainer.style.display = "flex";
    }
  });
}
// ------------------ WebRTC + Dynamic CallId ------------------
let localStream, remoteStream, pc;
let currentCallId = null;

const servers = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

// Initiate outgoing call
async function initiateCall(type) {
  const toUser = currentUser === "Chand6202" ? "Anuradha8877" : "Chand6202";
  currentCallId = push(ref(db, "calls")).key; // Unique callId

  await startLocalStream(type);

  // Push call details
  set(ref(db, "calls/" + currentCallId), {
    from: currentUser,
    to: toUser,
    type: type,
    status: "ringing",
    timestamp: Date.now()
  });

  // Listen for answer and ICE
  listenCallUpdates(currentCallId);
}

// Start local media
async function startLocalStream(type) {
  localStream = await navigator.mediaDevices.getUserMedia({ 
    audio: true, 
    video: type === "video" 
  });
  document.getElementById("localVideo").srcObject = localStream;
  document.getElementById("videoCallContainer").style.display = "flex";

  pc = new RTCPeerConnection(servers);

  // Add local tracks
  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

  // Remote stream
  remoteStream = new MediaStream();
  document.getElementById("remoteVideo").srcObject = remoteStream;
  pc.ontrack = e => e.streams[0].getTracks().forEach(track => remoteStream.addTrack(track));

  // ICE candidate handling
  pc.onicecandidate = event => {
    if (event.candidate) {
      push(ref(db, "calls/" + currentCallId + "/ice"), event.candidate.toJSON());
    }
  };
}

// Listen for incoming call
function listenCalls() {
  onChildAdded(ref(db, "calls"), async snap => {
    const call = snap.val();
    const callKey = snap.key;

    if(call.to === currentUser && call.status === "ringing") {
      currentCallId = callKey;
      document.getElementById("incomingCall").style.display = "flex";
      document.getElementById("ringtone").play();

      document.querySelector(".incoming-call .accept").onclick = async () => {
        await startLocalStream(call.type);
        update(ref(db, "calls/" + callKey), { status: "accepted" });

        // Create answer
        pc.onnegotiationneeded = async () => {
          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);
          update(ref(db, "calls/" + callKey + "/sdp"), { offer: offer.toJSON() });
        }

        handleSignaling(callKey);
        document.getElementById("incomingCall").style.display = "none";
        document.getElementById("ringtone").pause();
      };

      document.querySelector(".incoming-call .reject").onclick = () => {
        update(ref(db, "calls/" + callKey), { status: "rejected" });
        document.getElementById("incomingCall").style.display = "none";
        document.getElementById("ringtone").pause();
      };
    }
  });
}

// Handle signaling (SDP + ICE)
function handleSignaling(callKey) {
  const sdpRef = ref(db, "calls/" + callKey + "/sdp");
  const iceRef = ref(db, "calls/" + callKey + "/ice");

  // Listen for remote offer/answer
  onValue(sdpRef, async snap => {
    const data = snap.val();
    if(!data) return;

    if(data.offer && pc.signalingState === "stable") {
      await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      update(ref(db, "calls/" + callKey + "/sdp"), { answer: answer.toJSON() });
    }
    if(data.answer && pc.signalingState !== "have-remote-offer") {
      await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
    }
  });

  // Listen for remote ICE
  onChildAdded(iceRef, snap => {
    const candidate = snap.val();
    pc.addIceCandidate(new RTCIceCandidate(candidate));
  });
}

// End call
document.getElementById("endCallBtn").onclick = () => {
  if(pc){
    pc.close();
    pc = null;
  }
  document.getElementById("videoCallContainer").style.display = "none";
  if(currentCallId){
    update(ref(db, "calls/" + currentCallId), { status: "ended" });
    currentCallId = null;
  }
};