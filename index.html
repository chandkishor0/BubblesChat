<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Romantic Bubble Chat</title>
<style>
  /* ====== Body & Background ====== */
  body {
    margin:0;
    font-family:Arial,sans-serif;
    overflow:hidden;
    height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
    background:linear-gradient(135deg,#ff9de2,#ff4da6);
    position:relative;
  }

  /* ====== Heart Bubble Animation ====== */
  .bubble {
    position:absolute;
    bottom:-50px;
    background:rgba(255,255,255,0.3);
    width:20px;
    height:20px;
    border-radius:50%;
    animation:rise 15s linear infinite;
  }
  @keyframes rise {
    0% { transform: translateY(0) scale(0.5); opacity:0.7; }
    50% { transform: translateY(-50vh) scale(1); opacity:1; }
    100% { transform: translateY(-110vh) scale(1.2); opacity:0; }
  }

  /* ====== Login Overlay ====== */
  .login-overlay {
    position:fixed;
    top:0; left:0; right:0; bottom:0;
    background:rgba(255,255,255,0.95);
    display:flex;
    justify-content:center;
    align-items:center;
    z-index:10;
    flex-direction:column;
  }
  .login-box {
    padding:25px;
    border-radius:15px;
    background:#fff;
    box-shadow:0 6px 15px rgba(0,0,0,0.3);
    display:flex;
    flex-direction:column;
    align-items:center;
  }
  .login-box input {
    width:220px;
    padding:12px;
    margin:7px 0;
    border-radius:10px;
    border:1px solid #ccc;
    font-size:14px;
  }
  .login-box button {
    width:100%;
    padding:12px;
    background:#ff4da6;
    border:none;
    color:#fff;
    border-radius:10px;
    cursor:pointer;
    font-size:16px;
    transition:0.3s;
  }
  .login-box button:hover { background:#ff1a75; }

  /* ====== Chat Container ====== */
  .chat-container {
    display:none;
    position:relative;
    width:100%;
    max-width:420px;
    height:90vh;
    backdrop-filter:blur(10px);
    background:rgba(255,255,255,0.15);
    border-radius:20px;
    display:flex;
    flex-direction:column;
    color:white;
    box-shadow:0px 0px 25px rgba(0,0,0,0.6);
    overflow:hidden;
  }
  #header {
    display:flex;
    align-items:center;
    gap:10px;
    padding:10px;
    font-weight:bold;
    font-size:18px;
  }
  #header img {
    width:35px;
    height:35px;
    border-radius:50%;
  }

  #messages {
    flex:1;
    overflow-y:auto;
    padding:10px;
  }
  .msg {
    padding:8px 12px;
    border-radius:12px;
    margin:5px;
    max-width:70%;
    word-wrap:break-word;
    position:relative;
    display:flex;
    align-items:flex-end;
    gap:6px;
  }
  .sent { background:#ffc0cb; color:black; align-self:flex-end; border-radius:15px 15px 0 15px; }
  .received { background:#fff; color:black; align-self:flex-start; border:1px solid #ddd; border-radius:15px 15px 15px 0; }
  .msg small { font-size:10px; color:gray; position:absolute; bottom:2px; right:8px; }

  .msg img { max-width:200px; border-radius:8px; margin-top:5px; }

  .input-row {
    display:flex;
    gap:5px;
    align-items:center;
    padding:8px;
    background:rgba(255,255,255,0.2);
    border-radius:12px;
    position:sticky;
    bottom:0;
  }
  #messageInput {
    flex:1;
    padding:10px;
    border-radius:10px;
    border:none;
  }
  .send-btn { background:#ff4da6; color:white; border-radius:10px; padding:10px 12px; cursor:pointer; }
  .upload-btn { background:#ff69b4; color:white; border-radius:10px; padding:10px 12px; cursor:pointer; }
  .clear-btn { background:#e91e63; color:white; border-radius:6px; padding:6px 10px; margin:5px; }

  .typing { font-size:12px; color:#fff; margin-left:10px; height:15px; }

  /* ====== Call Buttons ====== */
  .call-buttons {
    position:absolute;
    top:10px;
    right:15px;
    display:flex;
    gap:8px;
  }
  .call-btn {
    background:#ff4da6;
    border-radius:50%;
    padding:10px;
    cursor:pointer;
    color:white;
    font-size:18px;
    transition:0.3s;
  }
  .call-btn:hover { opacity:0.8; }
  .video-btn { background:#ff1a75; }

  /* ====== Incoming Call ====== */
  .incoming-call {
    position:fixed;
    top:0; left:0; right:0; bottom:0;
    background:rgba(0,0,0,0.7);
    display:none;
    justify-content:center;
    align-items:center;
    flex-direction:column;
    color:white;
    z-index:20;
  }
  .incoming-call button {
    margin:10px;
    padding:12px 20px;
    border-radius:8px;
    cursor:pointer;
    font-size:16px;
    transition:0.2s;
  }
  .accept { background:green; color:white; }
  .reject { background:red; color:white; }
  .incoming-call button:hover { opacity:0.9; }

  /* ====== Video Call Popup ====== */
  #videoCallContainer {
    position:fixed;
    top:10%;
    left:50%;
    transform:translateX(-50%);
    background:rgba(255,255,255,0.1);
    backdrop-filter:blur(15px);
    padding:10px;
    border-radius:15px;
    display:none;
    z-index:25;
    flex-direction:column;
    gap:10px;
  }
  #remoteVideo, #localVideo {
    width:250px;
    height:200px;
    background:black;
    border-radius:12px;
  }
  #endCallBtn {
    background:red;
    padding:8px 15px;
    color:white;
    border:none;
    border-radius:10px;
    cursor:pointer;
  }
</style>
</head>
<body>

<!-- Floating heart bubbles -->
<div class="bubble" style="width:25px; height:25px; left:10%; animation-duration:18s;"></div>
<div class="bubble" style="width:20px; height:20px; left:30%; animation-duration:22s;"></div>
<div class="bubble" style="width:30px; height:30px; left:70%; animation-duration:20s;"></div>
<div class="bubble" style="width:15px; height:15px; left:50%; animation-duration:25s;"></div>

<!-- Login Overlay -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-box">
    <h2>Login to Bubble Chat ðŸ’–</h2>
    <input type="text" id="username" placeholder="Hint: Anuradha / Chand Kishor">
    <input type="password" id="password" placeholder="Enter password">
    <button onclick="login()">Enter Chat</button>
  </div>
</div>

<!-- Chat Container -->
<div class="chat-container" id="chatContainer">
  <div id="header"><img id="userAvatar" src=""><span id="welcome"></span></div>

  <div class="call-buttons">
    <div class="call-btn" onclick="startCall('audio')">ðŸ“ž</div>
    <div class="call-btn video-btn" onclick="startCall('video')">ðŸ“¹</div>
  </div>

  <div id="messages"></div>
  <div id="typing" class="typing"></div>

  <div class="input-row">
    <input type="text" id="messageInput" placeholder="Type your message..." oninput="showTyping()" />
    <button class="send-btn" onclick="sendMessage()">Send</button>
    <button class="upload-btn" onclick="document.getElementById('imageInput').click()">ðŸ“·</button>
    <input type="file" id="imageInput" accept="image/*" style="display:none" onchange="sendImage(event)">
  </div>
  <button class="clear-btn" onclick="clearChat()">ðŸ—‘ Clear Chat</button>
</div>

<!-- Incoming call -->
<div class="incoming-call" id="incomingCall">
  <h2>Incoming Call...</h2>
  <button class="accept">Accept</button>
  <button class="reject">Reject</button>
</div>

<!-- Video Call Popup -->
<div id="videoCallContainer">
  <video id="remoteVideo" autoplay></video>
  <video id="localVideo" autoplay muted></video>
  <button id="endCallBtn">End Call</button>
</div>

<audio id="ringtone" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" loop></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, onValue, set, update, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

// ====== Firebase Config ======
const firebaseConfig = {
  apiKey: "AIzaSyB5C4PYCKfY9Rk7CVPNQ-JHX7iBF-DP4cE",
  authDomain: "bubblechat-8b913.firebaseapp.com",
  databaseURL: "https://bubblechat-8b913-default-rtdb.firebaseio.com/",
  projectId: "bubblechat-8b913",
  storageBucket: "bubblechat-8b913.appspot.com",
  messagingSenderId: "890679022385",
  appId: "1:890679022385:web:0391f6e09e0efdaa661610"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ====== Users ======
const avatars = {
  "Anuradha8877":"https://i.ibb.co/2yW6k5F/girl.png",
  "Chand6202":"https://i.ibb.co/9nY6c9b/boy.png"
};

let currentUser = null;

// ====== Login ======
function login(){
  const uname = document.getElementById("username").value.trim();
  const pass = document.getElementById("password").value.trim();
  if(uname==="Anuradha" && pass==="Anuradha8877") currentUser="Anuradha8877";
  else if(uname==="Chand Kishor" && pass==="Chand6202") currentUser="Chand6202";
  else { alert("Invalid login!"); return; }

  document.getElementById("loginOverlay").style.display="none";
  document.getElementById("chatContainer").style.display="flex";
  document.getElementById("welcome").innerText = "Welcome " + uname + " ðŸ’–";
  document.getElementById("userAvatar").src = avatars[currentUser];
  loadMessages();
  listenCalls();
}
window.login = login;

// ====== Chat ======
function loadMessages(){
  const msgRef = ref(db,"messages");
  onChildAdded(msgRef, (snap)=> displayMessage(snap.key, snap.val()));
}

function displayMessage(id,msg){
  const div = document.createElement("div");
  div.classList.add("msg", msg.user===currentUser?"sent":"received");
  if(msg.text) div.innerHTML = msg.text;
  if(msg.image) div.innerHTML = `<img src="${msg.image}">`;
  div.innerHTML += `<small>${msg.status==="sent"?"âœ…":msg.status==="delivered"?"âœ…âœ…":"ðŸ”µ"}</small>`;
  
  // Avatar
  const avatar = document.createElement("img");
  avatar.src = avatars[msg.user];
  avatar.style.width="25px";
  avatar.style.height="25px";
  avatar.style.borderRadius="50%";
  if(msg.user!==currentUser) div.prepend(avatar);

  div.onclick = ()=>{
    if(currentUser==="Chand6202" || currentUser===msg.user){
      remove(ref(db,"messages/"+id));
      div.remove();
    }
  }
  document.getElementById("messages").appendChild(div);
  document.getElementById("messages").scrollTop=document.getElementById("messages").scrollHeight;

  if(msg.user!==currentUser){
    update(ref(db,"messages/"+id),{status:"delivered"});
    setTimeout(()=> update(ref(db,"messages/"+id),{status:"read"}),2000);
  }
}

function sendMessage(){
  const txt = document.getElementById("messageInput").value;
  if(!txt.trim()) return;
  push(ref(db,"messages"),{text:txt,user:currentUser,status:"sent"});
  document.getElementById("messageInput").value="";
}
window.sendMessage = sendMessage;

function sendImage(event){
  const file=event.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e){
    push(ref(db,"messages"),{image:e.target.result,user:currentUser,status:"sent"});
    document.getElementById("imageInput").value="";
  }
  reader.readAsDataURL(file);
}
window.sendImage = sendImage;

function clearChat(){
  if(currentUser==="Chand6202"){
    set(ref(db,"messages"),{});
    document.getElementById("messages").innerHTML="";
  } else alert("Only admin can clear chat!");
}
window.clearChat = clearChat;

// ====== Typing ======
function showTyping(){
  set(ref(db,"typing/"+currentUser),true);
  setTimeout(()=> set(ref(db,"typing/"+currentUser),false),1500);
}
window.showTyping = showTyping;

onValue(ref(db,"typing"), snap => {
  const val = snap.val() || {};
  let txt = '';
  for(let user in val) if(val[user]) txt += `${user} is typing... `;
  document.getElementById("typing").innerText = txt;
});

// ====== Calls ======
let peerConnection;
let localStream;
const servers = {iceServers:[{urls:"stun:stun.l.google.com:19302"}]};

function startCall(type){
  const toUser = currentUser==="Chand6202"?"Anuradha8877":"Chand6202";
  push(ref(db,"calls"),{from:currentUser,to:toUser,type:type,status:"ringing",timestamp:Date.now()});
}
window.startCall=startCall;

function listenCalls(){
  onChildAdded(ref(db,"calls"), async (snap)=>{
    const call = snap.val();
    if(call.to===currentUser && call.status==="ringing"){
      const incoming = document.getElementById("incomingCall");
      incoming.style.display="flex";
      document.getElementById("ringtone").play();

      incoming.querySelector(".accept").onclick = async ()=>{
        update(ref(db,"calls/"+snap.key),{status:"accepted"});
        incoming.style.display="none";
        document.getElementById("ringtone").pause();
        await startWebRTC(call.from, call.type);
      }
      incoming.querySelector(".reject").onclick = ()=>{
        update(ref(db,"calls/"+snap.key),{status:"rejected"});
        incoming.style.display="none";
        document.getElementById("ringtone").pause();
      }
    }
  });
}

// ====== WebRTC ======
async function startWebRTC(peerUser,type){
  document.getElementById("videoCallContainer").style.display="flex";
  localStream = await navigator.mediaDevices.getUserMedia({video:type==="video",audio:true});
  document.getElementById("localVideo").srcObject = localStream;

  peerConnection = new RTCPeerConnection(servers);
  localStream.getTracks().forEach(track=>peerConnection.addTrack(track,localStream));

  peerConnection.ontrack = e => {
    document.getElementById("remoteVideo").srcObject = e.streams[0];
  }

  peerConnection.onicecandidate = e => {
    if(e.candidate){
      push(ref(db,"webrtc/"+peerUser+"/candidates"), e.candidate.toJSON());
    }
  }

  const offer = await peerConnection.createOffer();
  await peerConnection.setLocalDescription(offer);
  push(ref(db,"webrtc/"+peerUser+"/offer"), offer.toJSON());
}

// End Call
document.getElementById("endCallBtn").onclick = ()=>{
  if(peerConnection){
    peerConnection.close();
    peerConnection=null;
  }
  if(localStream){
    localStream.getTracks().forEach(track=>track.stop());
  }
  document.getElementById("videoCallContainer").style.display="none";
};
</script>
</body>
</html>