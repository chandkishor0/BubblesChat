<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chand & Anuradha Chat</title>
<style>
body{margin:0;font-family:Arial,sans-serif;height:100vh;background:linear-gradient(135deg,#6a11cb,#2575fc);display:flex;justify-content:center;align-items:center;overflow:hidden;}
.login-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;justify-content:center;align-items:center;flex-direction:column;color:white;z-index:5;}
.login-overlay input{padding:10px;border-radius:10px;border:none;margin:5px;width:200px;}
.login-overlay button{padding:10px 15px;border:none;border-radius:10px;background:tomato;color:white;cursor:pointer;}
.chat-container{width:95%;max-width:420px;background:rgba(0,0,0,0.6);backdrop-filter:blur(12px);border-radius:20px;padding:15px;color:white;box-shadow:0px 0px 20px rgba(0,0,0,0.5);display:flex;flex-direction:column;height:90vh;position:relative;}
#messages{flex:1;overflow-y:auto;background:rgba(255,255,255,0.2);border-radius:10px;padding:10px;margin-bottom:5px;}
.message{margin:5px 0;padding:8px 12px;border-radius:10px;display:inline-block;max-width:75%;word-wrap:break-word;position:relative;}
.chand{background:#ffcccc;color:black;}
.anuradha{background:#ccffcc;color:black;}
.message .tick{position:absolute;bottom:2px;right:4px;font-size:10px;color:green;}
.input-row{display:flex;gap:5px;align-items:center;}
#messageInput{flex:1;padding:10px;border:none;border-radius:10px;}
button.send-btn{padding:10px 12px;background:tomato;color:white;border:none;border-radius:10px;cursor:pointer;}
button.upload-btn{background:#4CAF50;font-size:18px;}
button.clear-btn{background:crimson;width:100%;margin-top:6px;}
#typing{font-size:12px;font-style:italic;margin-bottom:5px;color:#ddd;height:15px;}
video#remoteVideo{width:100%;height:100%;border-radius:8px;position:absolute;top:0;left:0;z-index:1;}
video#localVideo{width:150px;height:150px;border-radius:8px;position:absolute;bottom:10px;right:10px;z-index:2;}
button.call-btn{padding:8px 12px;margin:2px;background:#4CAF50;color:white;border:none;border-radius:8px;cursor:pointer;}
</style>
</head>
<body>

<!-- Login Overlay -->
<div class="login-overlay" id="loginOverlay">
  <h2>Login Chat</h2>
  <input type="text" id="usernameInput" placeholder="Chand / Anuradha">
  <button onclick="login()">Enter Chat</button>
  <small>Hint: Chand / Anuradha</small>
</div>

<!-- Chat UI -->
<div class="chat-container" id="chatContainer" style="display:none;">
  <h2 id="welcome"></h2>
  <div id="messages"></div>
  <div id="typing"></div>
  <div class="input-row">
    <input type="text" id="messageInput" placeholder="Type your message..." oninput="showTyping()">
    <button class="send-btn" onclick="sendMessage()">Send</button>
    <button class="upload-btn" onclick="document.getElementById('imageInput').click()">ðŸ“·</button>
    <input type="file" id="imageInput" accept="image/*" style="display:none" onchange="sendImage(event)">
  </div>
  <button class="clear-btn" onclick="clearChat()">ðŸ—‘ Clear Chat</button>
  <div style="margin-top:5px;">
    <button class="call-btn" onclick="startCall(otherUser,'audio')">Audio Call</button>
    <button class="call-btn" onclick="startCall(otherUser,'video')">Video Call</button>
  </div>
  <video id="remoteVideo" autoplay playsinline></video>
  <video id="localVideo" autoplay muted playsinline></video>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getDatabase, ref, push, set, onValue, update, remove, onChildAdded } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyB5C4PYCKfY9Rk7CVPNQ-JHX7iBF-DP4cE",
  authDomain: "bubblechat-8b913.firebaseapp.com",
  databaseURL: "https://bubblechat-8b913-default-rtdb.firebaseio.com",
  projectId: "bubblechat-8b913",
  storageBucket: "bubblechat-8b913.appspot.com",
  messagingSenderId: "890679022385",
  appId: "1:890679022385:web:0391f6e09e0efdaa661610"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let username = "";
let otherUser = "";
let localStream, pc, currentCallId;

// Login
function login() {
  const val = document.getElementById("usernameInput").value.trim().toLowerCase();
  if(val==="chand") { username="Chand6202"; otherUser="Anuradha8877"; }
  else if(val==="anuradha") { username="Anuradha8877"; otherUser="Chand6202"; }
  else { alert("Invalid username"); return; }
  document.getElementById("loginOverlay").style.display="none";
  document.getElementById("chatContainer").style.display="flex";
  document.getElementById("welcome").innerText="Welcome, "+username;
  loadMessages();
}

// Messages
function loadMessages(){
  const messagesDiv=document.getElementById("messages");
  const messagesRef = ref(db,"messages");
  onValue(messagesRef,(snapshot)=>{
    messagesDiv.innerHTML="";
    snapshot.forEach(msgSnap=>{
      const msg = msgSnap.val();
      const div = document.createElement("div");
      div.classList.add("message");
      div.classList.add(msg.user===username?"chand":"anuradha");
      if(msg.type==="image") div.innerHTML=msg.user+":<br><img src='"+msg.text+"' />";
      else div.innerText=msg.user+": "+msg.text;
      // Tick
      const tick = document.createElement("span");
      tick.classList.add("tick"); tick.innerText="âœ”";
      div.appendChild(tick);
      messagesDiv.appendChild(div);
    });
    messagesDiv.scrollTop=messagesDiv.scrollHeight;
  });
}

function sendMessage(){
  const text = document.getElementById("messageInput").value.trim();
  if(!text) return;
  const newMsgRef = push(ref(db,"messages"));
  set(newMsgRef,{ user:username, text:text, type:"text", status:"sent"});
  document.getElementById("messageInput").value="";
  hideTyping();
}

function sendImage(event){
  const file = event.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload=function(e){
    const newMsgRef=push(ref(db,"messages"));
    set(newMsgRef,{ user:username, text:e.target.result, type:"image", status:"sent"});
  }
  reader.readAsDataURL(file);
}

function clearChat(){ if(confirm("Clear chat for your side only?")) remove(ref(db,"messages")); }

// Typing
function showTyping(){ set(ref(db,"typing"),username+" is typing..."); }
function hideTyping(){ remove(ref(db,"typing")); }
const typingDiv=document.getElementById("typing");
onValue(ref(db,"typing"),snap=>{ typingDiv.innerText=snap.val()!==username+" is typing..."?snap.val():""; });

// WebRTC Audio/Video Call
async function startCall(toUser, type="audio"){
  if(currentCallId){ alert("Already in call!"); return; }
  currentCallId = push(ref(db,"calls")).key;
  pc = new RTCPeerConnection();
  localStream = await navigator.mediaDevices.getUserMedia({ audio:true, video:type==="video" });
  localStream.getTracks().forEach(track=>pc.addTrack(track,localStream));
  document.getElementById("localVideo").srcObject = localStream;
  pc.ontrack = e => document.getElementById("remoteVideo").srcObject = e.streams[0];
  pc.onicecandidate = e => { if(e.candidate) push(ref(db,`calls/${currentCallId}/candidates`), e.candidate.toJSON()); }
  const offer = await pc.createOffer(); await pc.setLocalDescription(offer);
  set(ref(db,`calls/${currentCallId}`),{ from:username, to:toUser, type:type, status:"ringing", offer:offer.toJSON() });
  // Listen for answer
  onValue(ref(db,`calls/${currentCallId}/answer`), async snap=>{ if(snap.exists()) await pc.setRemoteDescription(new RTCSessionDescription(snap.val())); });
  // Listen for remote ICE
  onChildAdded(ref(db,`calls/${currentCallId}/candidates`), snap=>{ pc.addIceCandidate(new RTCIceCandidate(snap.val())); });
}

// Receive calls
onValue(ref(db,"calls"), snap=>{
  snap.forEach(callSnap=>{
    const call = callSnap.val();
    if(call.to===username && call.status==="ringing" && !currentCallId){
      const accept = confirm(`${call.from} is calling (${call.type}). Accept?`);
      if(accept) acceptCall(callSnap.key, call); else update(ref(db,`calls/${callSnap.key}`),{status:"rejected"});
    }
  });
});

async function acceptCall(callId, call){
  currentCallId = callId;
  pc = new RTCPeerConnection();
  localStream = await navigator.mediaDevices.getUserMedia({ audio:true, video: call.type==="video" });
  localStream.getTracks().forEach(track=>pc.addTrack(track,localStream));
  document.getElementById("localVideo").srcObject = localStream;
  pc.ontrack = e => document.getElementById("remoteVideo").srcObject = e.streams[0];
  pc.onicecandidate = e => {
    if(e.candidate) push(ref(db,`calls/${currentCallId}/candidates`), e.candidate.toJSON());
  }

  // Set remote offer
  await pc.setRemoteDescription(new RTCSessionDescription(call.offer));

  // Create answer
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);

  // Push answer to Firebase
  update(ref(db,`calls/${currentCallId}`), { answer: answer.toJSON(), status:"accepted" });

  // Listen for remote ICE candidates
  onChildAdded(ref(db,`calls/${currentCallId}/candidates`), snap => {
    const candidate = new RTCIceCandidate(snap.val());
    pc.addIceCandidate(candidate);
  });
}

// End Call
function endCall(){
  if(pc){
    pc.close(); pc = null;
    currentCallId = null;
    if(localStream){
      localStream.getTracks().forEach(track=>track.stop());
      localStream = null;
    }
    document.getElementById("localVideo").srcObject = null;
    document.getElementById("remoteVideo").srcObject = null;
  }
    }                   
