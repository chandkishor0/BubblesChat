<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Anuradha & Chand Kishor WhatsApp Clone</title>
<style>
body {margin:0;font-family:'Comic Sans MS', cursive,sans-serif;background:linear-gradient(to bottom right,#ffcccc,#ffe6e6);}
.chat-container {width:100%; max-width:500px;margin:0 auto;background:#fff0f5;height:100vh;display:flex;flex-direction:column;box-shadow:0 0 10px pink;border-radius:10px;overflow:hidden;position:relative;}
.chat-header {background:#ff66b2;color:white;padding:15px;font-size:20px;font-weight:bold;display:flex;justify-content:space-between;align-items:center;}
.chat-header button {background:#ff99cc;color:white;border:none;padding:5px 10px;border-radius:20px;cursor:pointer;font-weight:bold;margin-left:5px;}
.chat-header button:hover {background:#ff3399;}
.chat-messages {flex:1;padding:10px;overflow-y:auto;background:#ffe6f0;display:flex;flex-direction:column;}
.chat-input {display:flex;padding:10px;background:#ffccdd;}
.chat-input input[type="text"] {flex:1;padding:10px;border-radius:25px;border:none;outline:none;font-size:16px;}
.chat-input button {background:#ff66b2;color:white;border:none;padding:10px 15px;margin-left:10px;border-radius:25px;cursor:pointer;font-weight:bold;}
.chat-input button:hover {background:#ff3399;}
.message {margin:5px 0;padding:10px 15px;border-radius:20px;max-width:70%;animation:fadeIn 0.3s ease;position:relative;word-wrap:break-word;}
.sent {background:#ff99cc;align-self:flex-end;}
.received {background:#ffb3d9;align-self:flex-start;}
.timestamp {font-size:10px;color:#990033;margin-top:2px;}
.seen {font-size:12px;color:#cc0066;position:absolute;bottom:2px;right:5px;}
@keyframes fadeIn {from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);}}
.typing {font-style:italic;color:#ff3399;padding:5px 10px;}
#callContainer, #incomingCall {display:none;flex-direction:column;align-items:center;background:#ffe6f0;padding:10px;position:absolute;top:0;left:0;width:100%;height:100%;justify-content:center;z-index:10;border-radius:10px;}
#callContainer video {border-radius:10px;margin:5px;}
#incomingCall {text-align:center;font-size:18px;font-weight:bold;}
#incomingCall button {margin:5px;padding:10px 20px;border-radius:20px;border:none;cursor:pointer;}
#incomingCall button.accept {background:#ff66b2;color:white;}
#incomingCall button.decline {background:#ff3399;color:white;}
.emoji-picker {position:absolute;bottom:60px;left:10px;display:none;background:white;border:1px solid #ff99cc;border-radius:10px;padding:5px;flex-wrap:wrap;}
.emoji-picker span {cursor:pointer;font-size:20px;margin:2px;}
.voice-btn {background:#ff3399;color:white;border:none;padding:5px 10px;border-radius:50%;cursor:pointer;margin-left:5px;}
.voice-btn:hover {background:#ff66b2;}
</style>
</head>
<body>

<div class="chat-container">
  <div class="chat-header">
    💖 Anuradha & Chand Kishor 💖
    <div>
      <button onclick="startCall('video')">📹 Video</button>
      <button onclick="startCall('audio')">📞 Audio</button>
      <button onclick="toggleEmoji()">😊</button>
      <input type="file" id="imageInput" style="display:none" accept="image/*" onchange="sendImage(event)">
      <button onclick="document.getElementById('imageInput').click()">📷</button>
      <button class="voice-btn" id="recordBtn">🎤</button>
    </div>
  </div>

  <div class="chat-messages" id="messages"></div>
  <div class="typing" id="typing"></div>
  <div class="chat-input">
    <input type="text" id="messageInput" placeholder="Type a message...">
    <button id="sendBtn">Send</button>
  </div>

  <div class="emoji-picker" id="emojiPicker">
    <span onclick="addEmoji('❤️')">❤️</span>
    <span onclick="addEmoji('😍')">😍</span>
    <span onclick="addEmoji('😘')">😘</span>
    <span onclick="addEmoji('😊')">😊</span>
    <span onclick="addEmoji('💌')">💌</span>
    <span onclick="addEmoji('💕')">💕</span>
    <span onclick="addEmoji('💖')">💖</span>
    <span onclick="addEmoji('💞')">💞</span>
    <span onclick="addEmoji('💓')">💓</span>
    <span onclick="addEmoji('💗')">💗</span>
  </div>
</div>

<div id="callContainer">
  <video id="localVideo" autoplay muted width="150"></video>
  <video id="remoteVideo" autoplay width="300"></video>
  <div id="callType"></div>
  <div id="callTimer">00:00</div>
  <button onclick="endCall()">End Call</button>
</div>

<div id="incomingCall">
  <p id="callerInfo"></p>
  <button class="accept" onclick="acceptCall()">Accept</button>
  <button class="decline" onclick="declineCall()">Decline</button>
</div>

<audio id="ringtone" src="https://actions.google.com/sounds/v1/alarms/phone_alerts.mp3" loop></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, set, onValue } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyB5C4PYCKfY9Rk7CVPNQ-JHX7iBF-DP4cE",
  authDomain: "bubblechat-8b913.firebaseapp.com",
  databaseURL: "https://bubblechat-8b913-default-rtdb.firebaseio.com",
  projectId: "bubblechat-8b913",
  storageBucket: "bubblechat-8b913.appspot.com",
  messagingSenderId: "890679022385",
  appId: "1:890679022385:web:0391f6e09e0efdaa661610"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const messagesRef = ref(db,'messages');
const inputField = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const messagesDiv = document.getElementById('messages');
const emojiPicker = document.getElementById('emojiPicker');
const typingDiv = document.getElementById('typing');
const recordBtn = document.getElementById('recordBtn');

let userName = prompt("Enter your name (Anuradha or Chand Kishor):");
if(userName!=="Anuradha" && userName!=="Chand Kishor"){ alert("Only Anuradha or Chand Kishor allowed!"); throw new Error("Invalid User"); }

// ================= Chat =================
sendBtn.addEventListener('click', ()=>{
  const msg = inputField.value.trim();
  if(!msg) return;
  push(messagesRef,{sender:userName,message:msg,timestamp:Date.now(),seen:false,type:'text'});
  inputField.value='';
});

inputField.addEventListener('keypress', (e)=>{
  if(e.key==='Enter') sendBtn.click();
});

onChildAdded(messagesRef,(data)=>{
  const msg = data.val();
  const div = document.createElement('div');
  div.classList.add('message', msg.sender===userName?'sent':'received');
  div.dataset.key = data.key;
  let content = msg.type==='text'? msg.message : (msg.type==='image'? `<img src="${msg.message}" style="max-width:200px;border-radius:10px;">` : `<audio controls src="${msg.message}"></audio>`);
  div.innerHTML = content + `<div class="timestamp" title="${new Date(msg.timestamp).toLocaleString()}">${new Date(msg.timestamp).toLocaleTimeString()}</div><div class="seen">${msg.seen?'✔✔':'✔'}</div>`;

  if(msg.sender===userName){
    const editBtn = document.createElement('button'); editBtn.textContent='✏️'; editBtn.style.marginLeft='5px';
    editBtn.onclick=()=>{ const newText=prompt("Edit message:",msg.message); if(newText){ set(ref(db,'messages/'+data.key),{...msg,message:newText}); } };
    const delBtn = document.createElement('button'); delBtn.textContent='🗑️'; delBtn.style.marginLeft='5px';
    delBtn.onclick=()=>{ set(ref(db,'messages/'+data.key),{...msg,message:'[Deleted]',type:'text'}); };
    div.appendChild(editBtn); div.appendChild(delBtn);
  }

  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

// ================= Typing =================
inputField.addEventListener('input', ()=>{ set(ref(db,'typing/'+userName), inputField.value!=='' ); });
onValue(ref(db,'typing'), snapshot=>{
  let typingUsers = [];
  snapshot.forEach(snap=>{ if(snap.key!==userName && snap.val()) typingUsers.push(snap.key); });
  typingDiv.textContent = typingUsers.length>0? typingUsers.join(',')+' is typing... 💌' : '';
});

// ================= Emoji =================
function toggleEmoji(){ emojiPicker.style.display = emojiPicker.style.display==='none'?'flex':'none'; }
function addEmoji(e){ inputField.value+=e; emojiPicker.style.display='none'; }

// ================= Image =================
function sendImage(event){
  const file = event.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e){ push(messagesRef,{sender:userName,message:e.target.result,timestamp:Date.now(),seen:false,type:'image'}); };
  reader.readAsDataURL(file);
}

// ================= Voice Notes =================
let mediaRecorder, audioChunks=[];
recordBtn.onclick = async ()=>{
  if(recordBtn.dataset.recording!=='true'){
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.start(); recordBtn.dataset.recording='true'; recordBtn.textContent='⏹';
    audioChunks=[];
    mediaRecorder.ondataavailable = e=>audioChunks.push(e.data);
    mediaRecorder.onstop = ()=>{
      const blob = new Blob(audioChunks,{type:'audio/webm'});
      const reader = new FileReader();
      reader.onload = function(e){ push(messagesRef,{sender:userName,message:e.target.result,timestamp:Date.now(),seen:false,type:'audio'}); };
      reader.readAsDataURL(blob);
    };
  }else{ mediaRecorder.stop(); recordBtn.dataset.recording='false'; recordBtn.textContent='🎤'; }
};

// ================= Notifications =================
if(Notification.permission!=='granted'){ Notification.requestPermission(); }
onChildAdded(messagesRef,(data)=>{
  const msg = data.val();
  if(msg.sender!==userName && Notification.permission==='granted'){ new Notification(`${msg.sender} says:`,{body:msg.type==='text'?msg.message:'[Media]'}); }
});

// ================= Call Logic Placeholder =================
// startCall, acceptCall, declineCall, endCall functions should be added for full audio/video
</script>
</body>
</html>