<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Anuradha & Chand Kishor WhatsApp Clone</title>
<style>
body {margin:0;font-family:'Comic Sans MS', cursive,sans-serif;background:linear-gradient(to bottom right,#ffcccc,#ffe6e6);}
.chat-container {width:100%; max-width:500px;margin:0 auto;background:#fff0f5;height:100vh;display:flex;flex-direction:column;box-shadow:0 0 10px pink;border-radius:10px;overflow:hidden;position:relative;}
.chat-header {background:#ff66b2;color:white;padding:15px;font-size:20px;font-weight:bold;display:flex;justify-content:space-between;align-items:center;}
.chat-header button {background:#ff99cc;color:white;border:none;padding:5px 10px;border-radius:20px;cursor:pointer;font-weight:bold;margin-left:5px;}
.chat-header button:hover {background:#ff3399;}
.chat-messages {flex:1;padding:10px;overflow-y:auto;background:#ffe6f0;display:flex;flex-direction:column;}
.chat-input {display:flex;padding:10px;background:#ffccdd;}
.chat-input input[type="text"] {flex:1;padding:10px;border-radius:25px;border:none;outline:none;font-size:16px;}
.chat-input button {background:#ff66b2;color:white;border:none;padding:10px 15px;margin-left:10px;border-radius:25px;cursor:pointer;font-weight:bold;}
.chat-input button:hover {background:#ff3399;}
.message {margin:5px 0;padding:10px 15px;border-radius:20px;max-width:70%;animation:fadeIn 0.3s ease;position:relative;word-wrap:break-word;}
.sent {background:#ff99cc;align-self:flex-end;}
.received {background:#ffb3d9;align-self:flex-start;}
.timestamp {font-size:10px;color:#990033;margin-top:2px;}
.seen {font-size:12px;color:#cc0066;position:absolute;bottom:2px;right:5px;}
@keyframes fadeIn {from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);}}
.typing {font-style:italic;color:#ff3399;padding:5px 10px;}
#callContainer, #incomingCall {display:none;flex-direction:column;align-items:center;background:#ffe6f0;padding:10px;position:absolute;top:0;left:0;width:100%;height:100%;justify-content:center;z-index:10;border-radius:10px;}
#callContainer video {border-radius:10px;margin:5px;}
#incomingCall {text-align:center;font-size:18px;font-weight:bold;}
#incomingCall button {margin:5px;padding:10px 20px;border-radius:20px;border:none;cursor:pointer;}
#incomingCall button.accept {background:#ff66b2;color:white;}
#incomingCall button.decline {background:#ff3399;color:white;}
.emoji-picker {position:absolute;bottom:60px;left:10px;display:none;background:white;border:1px solid #ff99cc;border-radius:10px;padding:5px;flex-wrap:wrap;}
.emoji-picker span {cursor:pointer;font-size:20px;margin:2px;}
.voice-btn {background:#ff3399;color:white;border:none;padding:5px 10px;border-radius:50%;cursor:pointer;margin-left:5px;}
.voice-btn:hover {background:#ff66b2;}
</style>
</head>
<body>

<div class="chat-container">
  <div class="chat-header">
    ğŸ’– Anuradha & Chand Kishor ğŸ’–
    <div>
      <button onclick="startCall('video')">ğŸ“¹ Video</button>
      <button onclick="startCall('audio')">ğŸ“ Audio</button>
      <button onclick="toggleEmoji()">ğŸ˜Š</button>
      <input type="file" id="imageInput" style="display:none" accept="image/*" onchange="sendImage(event)">
      <button onclick="document.getElementById('imageInput').click()">ğŸ“·</button>
      <button class="voice-btn" id="recordBtn">ğŸ¤</button>
    </div>
  </div>

  <div class="chat-messages" id="messages"></div>
  <div class="typing" id="typing"></div>
  <div class="chat-input">
    <input type="text" id="messageInput" placeholder="Type a message...">
    <button id="sendBtn">Send</button>
  </div>

  <div class="emoji-picker" id="emojiPicker">
    <span onclick="addEmoji('â¤ï¸')">â¤ï¸</span>
    <span onclick="addEmoji('ğŸ˜')">ğŸ˜</span>
    <span onclick="addEmoji('ğŸ˜˜')">ğŸ˜˜</span>
    <span onclick="addEmoji('ğŸ˜Š')">ğŸ˜Š</span>
    <span onclick="addEmoji('ğŸ’Œ')">ğŸ’Œ</span>
    <span onclick="addEmoji('ğŸ’•')">ğŸ’•</span>
    <span onclick="addEmoji('ğŸ’–')">ğŸ’–</span>
    <span onclick="addEmoji('ğŸ’')">ğŸ’</span>
    <span onclick="addEmoji('ğŸ’“')">ğŸ’“</span>
    <span onclick="addEmoji('ğŸ’—')">ğŸ’—</span>
  </div>
</div>

<div id="callContainer">
  <video id="localVideo" autoplay muted width="150"></video>
  <video id="remoteVideo" autoplay width="300"></video>
  <div id="callType"></div>
  <div id="callTimer">00:00</div>
  <button onclick="endCall()">End Call</button>
</div>

<div id="incomingCall">
  <p id="callerInfo"></p>
  <button class="accept" onclick="acceptCall()">Accept</button>
  <button class="decline" onclick="declineCall()">Decline</button>
</div>

<audio id="ringtone" src="https://actions.google.com/sounds/v1/alarms/phone_alerts.mp3" loop></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getDatabase, ref, push, set, onChildAdded, onValue } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyB5C4PYCKfY9Rk7CVPNQ-JHX7iBF-DP4cE",
  authDomain: "bubblechat-8b913.firebaseapp.com",
  databaseURL: "https://bubblechat-8b913-default-rtdb.firebaseio.com",
  projectId: "bubblechat-8b913",
  storageBucket: "bubblechat-8b913.appspot.com",
  messagingSenderId: "890679022385",
  appId: "1:890679022385:web:0391f6e09e0efdaa661610"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let userName = prompt("Enter your name (Anuradha or Chand Kishor):");
if(userName!=="Anuradha" && userName!=="Chand Kishor"){ alert("Only Anuradha or Chand Kishor allowed!"); throw new Error("Invalid User"); }

const messagesRef = ref(db,'messages');
const callRef = ref(db,'calls');

const messagesDiv = document.getElementById('messages');
const inputField = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const emojiPicker = document.getElementById('emojiPicker');
const typingDiv = document.getElementById('typing');
const recordBtn = document.getElementById('recordBtn');
const callContainer = document.getElementById('callContainer');
const incomingCallDiv = document.getElementById('incomingCall');
const callerInfo = document.getElementById('callerInfo');
const localVideo = document.getElementById('localVideo');
const remoteVideo = document.getElementById('remoteVideo');
const callTypeDiv = document.getElementById('callType');
const callTimer = document.getElementById('callTimer');
const ringtone = document.getElementById('ringtone');

// ================= Chat =================
sendBtn.addEventListener('click', ()=>{
  const msg = inputField.value.trim();
  if(!msg) return;
  push(messagesRef,{sender:userName,message:msg,timestamp:Date.now(),seen:false,type:'text'});
  inputField.value='';
});
inputField.addEventListener('keypress', e=>{if(e.key==='Enter') sendBtn.click();});
onChildAdded(messagesRef,data=>{
  const msg = data.val();
  const div = document.createElement('div');
  div.classList.add('message', msg.sender===userName?'sent':'received');
  let content = msg.type==='text'? msg.message : (msg.type==='image'? `<img src="${msg.message}" style="max-width:200px;border-radius:10px;">` : `<audio controls src="${msg.message}"></audio>`);
  div.innerHTML = content + `<div class="timestamp" title="${new Date(msg.timestamp).toLocaleString()}">${new Date(msg.timestamp).toLocaleTimeString()}</div><div class="seen">${msg.seen?'âœ”âœ”':'âœ”'}</div>`;
  if(msg.sender===userName){
    const editBtn=document.createElement('button'); editBtn.textContent='âœï¸'; editBtn.style.marginLeft='5px';
    editBtn.onclick=()=>{ const newText=prompt("Edit message:",msg.message); if(newText) set(ref(db,'messages/'+data.key),{...msg,message:newText}); };
    const delBtn=document.createElement('button'); delBtn.textContent='ğŸ—‘ï¸'; delBtn.style.marginLeft='5px';
    delBtn.onclick=()=>{ set(ref(db,'messages/'+data.key),{...msg,message:'[Deleted]',type:'text'}); };
    div.appendChild(editBtn); div.appendChild(delBtn);
  }
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

// ================= Typing =================
inputField.addEventListener('input', ()=>{
  set(ref(db,'typing/'+userName), inputField.value!=='' );
});

onValue(ref(db,'typing'), snapshot=>{
  let typingUsers = [];
  snapshot.forEach(snap=>{
    if(snap.key!==userName && snap.val()) typingUsers.push(snap.key);
  });
  typingDiv.textContent = typingUsers.length>0 ? typingUsers.join(',')+' is typing... ğŸ’Œ' : '';
});

// ================= Emoji =================
function toggleEmoji(){ emojiPicker.style.display = emojiPicker.style.display==='none'?'flex':'none'; }
function addEmoji(e){ inputField.value+=e; emojiPicker.style.display='none'; }

// ================= Image =================
function sendImage(event){
  const file = event.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e){
    push(messagesRef,{sender:userName,message:e.target.result,timestamp:Date.now(),seen:false,type:'image'});
  };
  reader.readAsDataURL(file);
}

// ================= Voice Notes =================
let mediaRecorder, audioChunks=[];
recordBtn.onclick = async ()=>{
  if(recordBtn.dataset.recording!=='true'){
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.start(); recordBtn.dataset.recording='true'; recordBtn.textContent='â¹';
    audioChunks=[];
    mediaRecorder.ondataavailable = e=>audioChunks.push(e.data);
    mediaRecorder.onstop = ()=>{
      const blob = new Blob(audioChunks,{type:'audio/webm'});
      const reader = new FileReader();
      reader.onload = function(e){
        push(messagesRef,{sender:userName,message:e.target.result,timestamp:Date.now(),seen:false,type:'audio'});
      };
      reader.readAsDataURL(blob);
    };
  }else{
    mediaRecorder.stop(); recordBtn.dataset.recording='false'; recordBtn.textContent='ğŸ¤';
  }
};

// ================= Notifications =================
if(Notification.permission!=='granted'){ Notification.requestPermission(); }
onChildAdded(messagesRef,(data)=>{
  const msg = data.val();
  if(msg.sender!==userName && Notification.permission==='granted'){
    new Notification(`${msg.sender} says:`,{body:msg.type==='text'?msg.message:'[Media]'});
  }
});

// ================= Call Logic (WebRTC + Firebase) =================
let localStream, pc, callRefInstance, callId, callTimerInterval;
const servers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

// Start Call (Audio/Video)
async function startCall(type){
  callId = 'call_shared';
  callRefInstance = ref(db,'calls/'+callId);
  localStream = await navigator.mediaDevices.getUserMedia({video:type==='video', audio:true});
  localVideo.srcObject = localStream;
  pc = new RTCPeerConnection(servers);
  localStream.getTracks().forEach(track=>pc.addTrack(track, localStream));
  pc.ontrack = e=>{ remoteVideo.srcObject = e.streams[0]; };
  pc.onicecandidate = e=>{
    if(e.candidate) push(ref(db,'calls/'+callId+'/candidates'), e.candidate.toJSON());
  };

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  await set(callRefInstance,{from:userName,type:type,offer:offer});

  onValue(callRefInstance, async snapshot=>{
    const data = snapshot.val();
    if(!data) return;
    if(data.answer && !pc.currentRemoteDescription){
      await pc.setRemoteDescription(data.answer);
      startCallTimer();
    }
  });

  onChildAdded(ref(db,'calls/'+callId+'/candidates'), snapshot=>{
    const candidate = new RTCIceCandidate(snapshot.val());
    pc.addIceCandidate(candidate);
  });

  callContainer.style.display='flex';
  callTypeDiv.textContent = type==='video'?'Video Call':'Audio Call';
}

// Accept Incoming Call
async function acceptCall(){
  incomingCallDiv.style.display='none';
  ringtone.pause();
  localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  localVideo.srcObject = localStream;
  pc = new RTCPeerConnection(servers);
  localStream.getTracks().forEach(track=>pc.addTrack(track, localStream));
  pc.ontrack = e=>{ remoteVideo.srcObject = e.streams[0]; };
  pc.onicecandidate = e=>{ if(e.candidate) push(ref(db,'calls/'+callId+'/candidates'), e.candidate.toJSON()); };

  const snap = await ref(db,'calls/'+callId).get();
  const offer = snap.val().offer;
  await pc.setRemoteDescription(offer);
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  await set(ref(db,'calls/'+callId+'/answer'), answer);

  onChildAdded(ref(db,'calls/'+callId+'/candidates'), snapshot=>{
    const candidate = new RTCIceCandidate(snapshot.val());
    pc.addIceCandidate(candidate);
  });

  callContainer.style.display='flex';
  startCallTimer();
}

// Decline Call
function declineCall(){
  incomingCallDiv.style.display='none';
  ringtone.pause();
  set(ref(db,'calls/'+callId), null);
}

// End Call
function endCall(){
  if(pc){ pc.close(); pc=null; }
  if(localStream){ localStream.getTracks().forEach(t=>t.stop()); }
  callContainer.style.display='none';
  clearInterval(callTimerInterval); callTimer.textContent='00:00';
  set(ref(db,'calls/'+callId), null);
}

// Incoming call listener
onValue(ref(db,'calls'), snapshot=>{
  const calls = snapshot.val();
  if(!calls) return;
  for(let id in calls){
    const c = calls[id];
    if(c.from !== userName){
      callId = id; callRefInstance = ref(db,'calls/'+callId);
      incomingCallDiv.style.display='flex';
      callerInfo.textContent = `${c.from} is calling (${c.type})...`;
      ringtone.play();
    }
  }
});

// Call Timer
function startCallTimer(){
  let seconds=0; callTimerInterval=setInterval(()=>{
    seconds++;
    let m=Math.floor(seconds/60).toString().padStart(2,'0');
    let s=(seconds%60).toString().padStart(2,'0');
    callTimer.textContent = `${m}:${s}`;
  },1000);
}
</script>
</body>
</html>